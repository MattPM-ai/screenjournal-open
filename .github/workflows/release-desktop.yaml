# Release Desktop App Workflow
#
# Builds and publishes the ScreenJournal Open desktop app for all platforms.
# This version bundles all services (databases, backends, frontend) into a standalone app.
# Triggers on version tags (v*.*.*) or manual dispatch.
#
# Required secrets for Apple signing (add when ready):
#   APPLE_CERTIFICATE - Base64-encoded .p12 certificate
#   APPLE_CERTIFICATE_PASSWORD - Certificate password
#   APPLE_SIGNING_IDENTITY - e.g., "Developer ID Application: Your Name (TEAM_ID)"
#   APPLE_ID - Apple ID email for notarization
#   APPLE_PASSWORD - App-specific password
#   APPLE_TEAM_ID - 10-character team ID
#
# Required secrets for Windows signing (add when ready):
#   WINDOWS_CERTIFICATE - Base64-encoded certificate
#   WINDOWS_CERTIFICATE_PASSWORD - Certificate password

name: Release Desktop App

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.0.0)'
        required: true
        type: string

env:
  CARGO_TERM_COLOR: always

jobs:
  # =============================================================================
  # Create GitHub Release (Draft)
  # =============================================================================
  create-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      release_id: ${{ steps.create-release.outputs.result }}
      version: ${{ steps.version.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi

      - name: Create Release
        id: create-release
        uses: actions/github-script@v7
        with:
          script: |
            const { data } = await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: `v${{ steps.version.outputs.version }}`,
              name: `ScreenJournal Open v${{ steps.version.outputs.version }}`,
              body: `## ScreenJournal Open v${{ steps.version.outputs.version }}\n\nDownload the installer for your platform below.\n\n### Installation\n- **macOS**: Download the .dmg file and drag to Applications\n- **Windows**: Download and run the .exe installer or extract the .zip file\n- **Linux**: Download the .deb package and install with \`sudo dpkg -i\``,
              draft: true,
              prerelease: false
            })
            return data.id

  # =============================================================================
  # Build for All Platforms
  # =============================================================================
  build:
    needs: create-release
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          # macOS (build script handles both arm64 and x64)
          - platform: macos-latest
            build_script: './build-bundled.sh'
            artifact_name: macOS-universal
            artifact_pattern: 'screenjournal/apps/desktop/src-tauri/target/release/bundle/dmg/*.dmg'
          # Linux
          - platform: ubuntu-22.04
            build_script: './build-bundled-linux.sh'
            artifact_name: Linux-x64
            artifact_pattern: 'screenjournal/apps/desktop/src-tauri/target/release/bundle/deb/*.deb'
          # Windows
          - platform: windows-latest
            build_script: './build-bundled-windows.sh'
            artifact_name: Windows-x64

    runs-on: ${{ matrix.platform }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache-dependency-path: |
            sj-collector/go.sum
            sj-tracker-report/go.sum

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './screenjournal/apps/desktop/src-tauri -> target'

      # =========================================================================
      # Platform-specific dependencies
      # =========================================================================
      - name: Install Linux dependencies
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libappindicator3-dev \
            librsvg2-dev \
            patchelf \
            libssl-dev \
            libpipewire-0.3-dev \
            ffmpeg \
            dpkg-dev

      - name: Install macOS dependencies
        if: matrix.platform == 'macos-latest'
        run: |
          brew install ffmpeg || true

      - name: Install Windows dependencies
        if: matrix.platform == 'windows-latest'
        run: |
          # Windows dependencies are typically pre-installed in GitHub Actions
          # Visual Studio Build Tools should be available
          echo "Windows dependencies should be pre-installed"

      # =========================================================================
      # Install npm dependencies
      # =========================================================================
      - name: Install root dependencies
        run: npm ci
        working-directory: screenjournal

      - name: Install desktop dependencies
        run: npm ci
        working-directory: screenjournal/apps/desktop

      - name: Install frontend dependencies
        run: npm ci
        working-directory: sj-tracker-frontend

      # =========================================================================
      # Make build script executable and run it
      # =========================================================================
      - name: Make build script executable
        if: matrix.platform != 'windows-latest'
        run: chmod +x ${{ matrix.build_script }}

      - name: Run bundled build script (Unix)
        if: matrix.platform != 'windows-latest'
        shell: bash
        run: ${{ matrix.build_script }}
        env:
          # Gemini API key - embedded at build time if needed
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          # Apple signing - uncomment when certificates are configured
          # APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          # APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          # APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
          # APPLE_ID: ${{ secrets.APPLE_ID }}
          # APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          # APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}

      - name: Run bundled build script (Windows)
        if: matrix.platform == 'windows-latest'
        shell: bash
        run: bash ${{ matrix.build_script }}
        env:
          # Gemini API key - embedded at build time if needed
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          # Windows signing - uncomment when certificate is configured
          # WINDOWS_CERTIFICATE: ${{ secrets.WINDOWS_CERTIFICATE }}
          # WINDOWS_CERTIFICATE_PASSWORD: ${{ secrets.WINDOWS_CERTIFICATE_PASSWORD }}

      # =========================================================================
      # Upload artifacts to release
      # =========================================================================
      - name: Find and upload macOS DMG
        if: matrix.platform == 'macos-latest'
        uses: actions/github-script@v7
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RELEASE_ID: ${{ needs.create-release.outputs.release_id }}
          VERSION: ${{ needs.create-release.outputs.version }}
          ARTIFACT_NAME: ${{ matrix.artifact_name }}
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            const { execSync } = require('child_process');
            
            // Find DMG file
            const dmgPattern = 'screenjournal/apps/desktop/src-tauri/target/release/bundle/dmg/*.dmg';
            const dmgFiles = execSync(`find screenjournal/apps/desktop/src-tauri/target -name "*.dmg" -type f`, { encoding: 'utf-8' }).trim().split('\n').filter(f => f);
            
            if (dmgFiles.length === 0) {
              throw new Error('No DMG file found');
            }
            
            const dmgPath = dmgFiles[0];
            const dmgName = `ScreenJournal-Open-${process.env.ARTIFACT_NAME}-${process.env.VERSION}.dmg`;
            
            console.log(`Uploading ${dmgPath} as ${dmgName}`);
            
            const { data } = await github.rest.repos.uploadReleaseAsset({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: parseInt(process.env.RELEASE_ID),
              name: dmgName,
              data: fs.readFileSync(dmgPath),
              headers: {
                'content-type': 'application/x-apple-diskimage',
                'content-length': fs.statSync(dmgPath).size
              }
            });
            
            console.log(`Uploaded: ${data.browser_download_url}`);

      - name: Find and upload Linux DEB
        if: matrix.platform == 'ubuntu-22.04'
        uses: actions/github-script@v7
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RELEASE_ID: ${{ needs.create-release.outputs.release_id }}
          VERSION: ${{ needs.create-release.outputs.version }}
          ARTIFACT_NAME: ${{ matrix.artifact_name }}
        with:
          script: |
            const fs = require('fs');
            const { execSync } = require('child_process');
            
            // Find DEB file
            const debFiles = execSync(`find screenjournal/apps/desktop/src-tauri/target -name "*.deb" -type f`, { encoding: 'utf-8' }).trim().split('\n').filter(f => f);
            
            if (debFiles.length === 0) {
              throw new Error('No DEB file found');
            }
            
            const debPath = debFiles[0];
            const debName = `ScreenJournal-Open-${process.env.ARTIFACT_NAME}-${process.env.VERSION}.deb`;
            
            console.log(`Uploading ${debPath} as ${debName}`);
            
            const { data } = await github.rest.repos.uploadReleaseAsset({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: parseInt(process.env.RELEASE_ID),
              name: debName,
              data: fs.readFileSync(debPath),
              headers: {
                'content-type': 'application/vnd.debian.binary-package',
                'content-length': fs.statSync(debPath).size
              }
            });
            
            console.log(`Uploaded: ${data.browser_download_url}`);

      - name: Find and upload Windows installer
        if: matrix.platform == 'windows-latest'
        uses: actions/github-script@v7
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RELEASE_ID: ${{ needs.create-release.outputs.release_id }}
          VERSION: ${{ needs.create-release.outputs.version }}
          ARTIFACT_NAME: ${{ matrix.artifact_name }}
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            const { execSync } = require('child_process');
            
            // Try to find .exe installer first (in nsis directory)
            let installerPath = null;
            let installerName = null;
            let contentType = 'application/x-msdownload';
            
            try {
              // Use find command (available in Git Bash on Windows)
              const exeFiles = execSync(`find screenjournal/apps/desktop/src-tauri/target -path "*/nsis/*.exe" -type f`, { 
                encoding: 'utf-8'
              }).trim().split('\n').filter(f => f);
              
              if (exeFiles.length > 0) {
                installerPath = exeFiles[0].trim();
                installerName = `ScreenJournal-Open-${process.env.ARTIFACT_NAME}-${process.env.VERSION}.exe`;
              }
            } catch (e) {
              console.log('No .exe installer found, trying zip...');
            }
            
            // Fallback to zip if no .exe found
            if (!installerPath) {
              try {
                const zipFiles = execSync(`find screenjournal/apps/desktop/src-tauri/target -name "*.zip" -type f`, {
                  encoding: 'utf-8'
                }).trim().split('\n').filter(f => f);
                
                if (zipFiles.length > 0) {
                  installerPath = zipFiles[0].trim();
                  installerName = `ScreenJournal-Open-${process.env.ARTIFACT_NAME}-${process.env.VERSION}.zip`;
                  contentType = 'application/zip';
                }
              } catch (e) {
                throw new Error('No installer or zip file found');
              }
            }
            
            console.log(`Uploading ${installerPath} as ${installerName}`);
            
            const { data } = await github.rest.repos.uploadReleaseAsset({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: parseInt(process.env.RELEASE_ID),
              name: installerName,
              data: fs.readFileSync(installerPath),
              headers: {
                'content-type': contentType,
                'content-length': fs.statSync(installerPath).size
              }
            });
            
            console.log(`Uploaded: ${data.browser_download_url}`);

  # =============================================================================
  # Publish Release (after all builds complete)
  # =============================================================================
  publish-release:
    runs-on: ubuntu-latest
    needs: [create-release, build]
    permissions:
      contents: write
    steps:
      - name: Publish Release
        uses: actions/github-script@v7
        env:
          RELEASE_ID: ${{ needs.create-release.outputs.release_id }}
        with:
          script: |
            await github.rest.repos.updateRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: process.env.RELEASE_ID,
              draft: false
            })
            console.log(`Published release ${process.env.RELEASE_ID}`)
