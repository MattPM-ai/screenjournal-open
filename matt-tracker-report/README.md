# Matt Tracker Report Backend

A lightweight, scalable Go backend service that generates productivity reports from InfluxDB time monitoring data using OpenAI GPT-4.1 mini with structured JSON outputs.

## Features

- **Async Task-Based API**: Generate reports asynchronously with UUID-based task tracking
- **InfluxDB Integration**: Query time-series data from InfluxDB measurements
- **AI-Powered Reports**: Generate detailed productivity reports using OpenAI GPT-4.1 mini
- **Structured Output**: Deterministic JSON reports validated against JSON schema
- **Scalable Architecture**: Lightweight Go implementation designed for high performance

## Architecture

The backend follows an async task-based pattern:

1. **Generate Endpoint**: Creates a task and returns UUID immediately
2. **Status Endpoint**: Polls task status and retrieves completed reports
3. **In-Memory Task Management**: Active tasks stored in memory
4. **MongoDB Caching**: Completed reports stored in MongoDB (deferred implementation)

## Project Structure

```
matt-tracker-report/
├── cmd/server/          # Application entry point
├── internal/
│   ├── api/             # HTTP handlers and routes
│   ├── config/          # Configuration management
│   ├── database/        # InfluxDB client
│   ├── models/          # Data structures
│   ├── services/        # Business logic services
│   ├── validation/      # JSON schema validation
│   └── utils/           # Utility functions
├── schemas/              # JSON schemas
└── prompts/              # AI system prompts
```

## Prerequisites

- Go 1.21 or later
- InfluxDB instance with data in the following measurements:
  - `afk_status`
  - `app_usage`
  - `daily_metrics`
  - `window_activity`
- OpenAI API key

## Installation

1. Clone the repository:
```bash
git clone <repository-url>
cd matt-tracker-report
```

2. Install dependencies:
```bash
go mod download
```

3. Create `.env` file from `.env.example`:
```bash
cp .env.example .env
```

4. Configure environment variables in `.env`:
```env
INFLUXDB_URL=http://localhost:8086
INFLUXDB_TOKEN=your_token_here
INFLUXDB_ORG=your_org
INFLUXDB_BUCKET=your_bucket

OPENAI_API_KEY=your_api_key_here

JWT_SECRET=your_jwt_secret_here

PORT=8080
HOST=0.0.0.0
```

## Running the Server

```bash
go run cmd/server/main.go
```

The server will start on `http://localhost:8080` (or the configured port).

## Authentication

All API endpoints (except `/health`) require JWT authentication. The service validates JWT tokens generated by `mattpm-backend` but does not generate tokens itself.

### Authentication Header

Include the JWT token in the `Authorization` header:

```
Authorization: Bearer <your-jwt-token>
```

### Configuration

Set `JWT_SECRET` in your `.env` file to match the secret used by `mattpm-backend`:

```env
JWT_SECRET=your-super-secret-jwt-key-change-in-production
```

The JWT token must contain:
- `userId`: User ID (string)
- `email`: User email (string)
- Standard JWT claims (`iat`, `exp`)

## API Endpoints

### 1. Generate Report

**POST** `/api/reports/generate`

**Requires Authentication:** Yes

Generates a new report asynchronously and returns a task ID.

**Request Body:**
```json
{
  "org": "Turbo",
  "users": ["ben"],
  "startDate": "2025-11-19",
  "endDate": "2025-11-19"
}
```

**Response:**
```json
{
  "taskId": "uuid-here",
  "status": "pending"
}
```

### 2. Get Task Status

**GET** `/api/reports/status/:taskId`

**Requires Authentication:** Yes

Retrieves the status of a report generation task.

**Response (Processing):**
```json
{
  "taskId": "uuid-here",
  "status": "processing"
}
```

**Response (Completed):**
```json
{
  "taskId": "uuid-here",
  "status": "completed",
  "report": {
    "organizations": [...],
    "generatedAt": "2025-11-19T22:00:00Z",
    "periodAnalyzed": {
      "startDate": "2025-11-19",
      "endDate": "2025-11-19"
    }
  }
}
```

**Response (Failed):**
```json
{
  "taskId": "uuid-here",
  "status": "failed",
  "error": "error message"
}
```

### 3. Health Check

**GET** `/health`

Returns server health status.

## Report Structure

Reports include:

- **Organizations**: Grouped by organization name
- **Users**: Individual user reports within organizations
- **Overall Report**: Period summary with totals, averages, and AI-generated summary/conclusion
- **Daily Reports**: Day-by-day breakdowns with:
  - Hourly breakdowns (0-23 hours)
  - App usage per hour
  - Window titles
  - Notable discrepancies
  - Daily summaries

## Development

### Building

```bash
go build -o bin/server cmd/server/main.go
```

### Running Tests

```bash
go test ./...
```

## Configuration

All configuration is managed through environment variables. See `.env.example` for all available options.

### InfluxDB Configuration

- `INFLUXDB_URL`: InfluxDB server URL
- `INFLUXDB_TOKEN`: Authentication token
- `INFLUXDB_ORG`: Organization name
- `INFLUXDB_BUCKET`: Bucket name

### OpenAI Configuration

- `OPENAI_API_KEY`: OpenAI API key
- `OPENAI_MODEL`: Model name (default: `gpt-4o-mini`)
- `OPENAI_TEMPERATURE`: Temperature for generation (default: `0.3`)
- `OPENAI_MAX_TOKENS`: Maximum tokens (default: `4000`)

### Server Configuration

- `PORT`: Server port (default: `8080`)
- `HOST`: Server host (default: `0.0.0.0`)

### Authentication Configuration

- `JWT_SECRET`: JWT secret key (must match `mattpm-backend` JWT_SECRET)

## Future Enhancements

- MongoDB caching for completed reports
- Support for multiple users in a single request
- Rate limiting
- Report caching with TTL
- Webhook notifications for completed reports

## License

[Your License Here]

# matt-tracker-report
