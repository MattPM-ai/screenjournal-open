# Release Desktop App Workflow
#
# Builds and publishes the ScreenJournal Tracker desktop app for all platforms.
# Triggers on version tags (v*.*.*) or manual dispatch.
#
# Required secrets for Apple signing (add when ready):
#   APPLE_CERTIFICATE - Base64-encoded .p12 certificate
#   APPLE_CERTIFICATE_PASSWORD - Certificate password
#   APPLE_SIGNING_IDENTITY - e.g., "Developer ID Application: Your Name (TEAM_ID)"
#   APPLE_ID - Apple ID email for notarization
#   APPLE_PASSWORD - App-specific password
#   APPLE_TEAM_ID - 10-character team ID
#
# Required secrets for Windows signing (add when ready):
#   WINDOWS_CERTIFICATE - Base64-encoded certificate
#   WINDOWS_CERTIFICATE_PASSWORD - Certificate password

name: Release Desktop App

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.0.0)'
        required: true
        type: string

env:
  CARGO_TERM_COLOR: always

jobs:
  # =============================================================================
  # Create GitHub Release (Draft)
  # =============================================================================
  create-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      release_id: ${{ steps.create-release.outputs.result }}
      version: ${{ steps.version.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi

      - name: Create Release
        id: create-release
        uses: actions/github-script@v7
        with:
          script: |
            const { data } = await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: `v${{ steps.version.outputs.version }}`,
              name: `ScreenJournal Tracker v${{ steps.version.outputs.version }}`,
              body: `## ScreenJournal Tracker v${{ steps.version.outputs.version }}\n\nDownload the installer for your platform below.\n\n### Installation\n- **macOS**: Download the .dmg file and drag to Applications\n- **Windows**: Download and run the .exe installer\n- **Linux**: Download the .AppImage or .deb package`,
              draft: true,
              prerelease: false
            })
            return data.id

  # =============================================================================
  # Build for All Platforms
  # =============================================================================
  build:
    needs: create-release
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          # macOS Apple Silicon
          - platform: macos-latest
            args: '--target aarch64-apple-darwin'
            rust_targets: 'aarch64-apple-darwin'
            name: macOS-arm64
          # macOS Intel
          - platform: macos-latest
            args: '--target x86_64-apple-darwin'
            rust_targets: 'x86_64-apple-darwin'
            name: macOS-x64
          # Linux (temporarily disabled)
          # - platform: ubuntu-22.04
          #   args: ''
          #   rust_targets: ''
          #   name: Linux-x64
          # Windows
          - platform: windows-latest
            args: ''
            rust_targets: ''
            name: Windows-x64

    runs-on: ${{ matrix.platform }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.rust_targets }}

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './apps/desktop/src-tauri -> target'

      # =========================================================================
      # Platform-specific dependencies
      # =========================================================================
      - name: Install Linux dependencies
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libappindicator3-dev \
            librsvg2-dev \
            patchelf \
            libssl-dev \
            libpipewire-0.3-dev

      - name: Install macOS dependencies (FFmpeg for Rust compilation)
        if: matrix.platform == 'macos-latest'
        run: |
          brew install ffmpeg

      # =========================================================================
      # Install npm dependencies
      # =========================================================================
      - name: Install root dependencies
        run: npm ci

      - name: Install desktop dependencies
        run: npm ci
        working-directory: apps/desktop

      # =========================================================================
      # Setup bundled resources (ActivityWatch, FFmpeg)
      # =========================================================================
      - name: Setup ActivityWatch
        run: npm run setup-aw
        working-directory: apps/desktop

      - name: Setup FFmpeg binary
        run: npm run setup-ffmpeg
        working-directory: apps/desktop

      - name: Verify resources
        run: npm run check
        working-directory: apps/desktop

      # =========================================================================
      # Build monorepo packages (UI styles needed by desktop)
      # =========================================================================
      - name: Build UI package
        run: npm run build --workspace=@repo/ui

      # =========================================================================
      # Build and upload using tauri-action
      # =========================================================================
      - name: Build Tauri App
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # Gemini API key - embedded at build time
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          # Apple signing - uncomment when certificates are configured
          # APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          # APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          # APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
          # APPLE_ID: ${{ secrets.APPLE_ID }}
          # APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          # APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          # Windows signing - uncomment when certificate is configured
          # WINDOWS_CERTIFICATE: ${{ secrets.WINDOWS_CERTIFICATE }}
          # WINDOWS_CERTIFICATE_PASSWORD: ${{ secrets.WINDOWS_CERTIFICATE_PASSWORD }}
        with:
          projectPath: apps/desktop
          releaseId: ${{ needs.create-release.outputs.release_id }}
          args: ${{ matrix.args }}
          # Generate updater artifacts (latest.json, .sig files)
          updaterJsonKeepUniversal: true

  # =============================================================================
  # Publish Release (after all builds complete)
  # =============================================================================
  publish-release:
    runs-on: ubuntu-latest
    needs: [create-release, build]
    permissions:
      contents: write
    steps:
      - name: Publish Release
        uses: actions/github-script@v7
        env:
          RELEASE_ID: ${{ needs.create-release.outputs.release_id }}
        with:
          script: |
            await github.rest.repos.updateRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: process.env.RELEASE_ID,
              draft: false
            })
            console.log(`Published release ${process.env.RELEASE_ID}`)
