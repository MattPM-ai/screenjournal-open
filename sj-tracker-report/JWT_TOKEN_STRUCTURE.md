# JWT Token Structure

This document describes the structure of JWT tokens generated by `screenjournal-backend` and validated by this service.

## Token Format

JWT tokens follow the standard three-part structure:
```
<header>.<payload>.<signature>
```

## Header

The JWT header contains:
```json
{
  "alg": "HS256",
  "typ": "JWT"
}
```

- **Algorithm**: HMAC SHA-256 (HS256)
- **Type**: JWT

## Payload (Claims)

The token payload contains the following claims:

### Custom Claims

```json
{
  "userId": "28",
  "email": "common@deltamax.tech"
}
```

- **userId** (string): The user's ID as a string (e.g., "28")
- **email** (string): The user's email address

### Standard Claims (Registered Claims)

```json
{
  "iat": 1765560048,
  "exp": 1765560948
}
```

- **iat** (number): Issued at timestamp (Unix timestamp in seconds)
- **exp** (number): Expiration timestamp (Unix timestamp in seconds)

### Complete Payload Example

```json
{
  "userId": "28",
  "email": "common@deltamax.tech",
  "iat": 1765560048,
  "exp": 1765560948
}
```

## Token Expiry

- **Access Token**: 15 minutes (`ACCESS_TOKEN_EXPIRY = '15m'`)
- **Refresh Token**: 7 days (`REFRESH_TOKEN_EXPIRY = '7d'`)

## Token Generation (screenjournal-backend)

Tokens are generated in `screenjournal-backend/src/users/utils/jwt.ts`:

```typescript
const payload: Omit<TokenPayload, 'iat' | 'exp'> = {
  userId,
  email
};

const token = jwt.sign(payload, JWT_SECRET, { 
  expiresIn: ACCESS_TOKEN_EXPIRY 
});
```

## Token Validation (sj-tracker-report)

Tokens are validated in `internal/middleware/auth.go`:

```go
type TokenClaims struct {
    UserId string `json:"userId"`
    Email  string `json:"email"`
    jwt.RegisteredClaims
}
```

The middleware:
1. Extracts the Bearer token from the `Authorization` header
2. Verifies the token signature using `JWT_SECRET`
3. Validates token expiration
4. Extracts `userId` and `email` from claims
5. Attaches user info to the request context

## Example Token

A complete JWT token looks like:
```
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOiIyOCIsImVtYWlsIjoiY29tbW9uQGRlbHRhbWF4LnRlY2giLCJpYXQiOjE3NjU1NjAwNDgsImV4cCI6MTc2NTU2MDk0OH0.-00MTB1v3MOCPS11Csn_88yxLymTlfsJuoHZ7KpIy2s
```

When decoded:
- **Header**: `{"alg":"HS256","typ":"JWT"}`
- **Payload**: `{"userId":"28","email":"common@deltamax.tech","iat":1765560048,"exp":1765560948}`
- **Signature**: HMAC-SHA256 signature using `JWT_SECRET`

## Usage in API Requests

Include the token in the `Authorization` header:

```
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

## Important Notes

1. **JWT_SECRET**: Must match between `screenjournal-backend` and `sj-tracker-report`
2. **userId Type**: Stored as string in token, converted to int in middleware
3. **No account_id**: The `account_id` is NOT in the token - it's stored in the user object in the database
4. **Token Validation**: This service only validates tokens, it does NOT generate them

## Error Responses

If token validation fails, the middleware returns:

```json
{
  "error": "Unauthorized",
  "message": "token expired" | "malformed token" | "invalid token" | "JWT_SECRET not configured"
}
```

HTTP Status: `401 Unauthorized`






